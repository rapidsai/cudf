---
description: Add pinned vector factories in libcudf and use them across parquet
globs: 
alwaysApply: false
---

# Add pinned vector factories in libcudf

1. Add pinned vector factories similar to the ones for the `make_host_vector` and `make_host_vector_async` in `cudf/cpp/include/cudf/detail/utilities/vector_factories.hpp`. See changes in the PR https://github.com/rapidsai/cudf/pull/20995/changes to find existing changes that implement most of this. The input to the pinned vector factories may be `device_span`, a device `Container`, a host (or std::vector like) `Container`, or a`host_span` to pageable memory (do an std::move in this case)

For example:
```c++
template <typename T>
host_vector<T> make_pinned_vector_async(device_span<T const> source_data,
                                        rmm::cuda_stream_view stream)
{
  auto result = make_pinned_vector_async<T>(source_data.size(), stream);
  cuda_memcpy_async<T>(result, source_data, stream);
  return result;
}
```

Another example:

```c++
template <typename Container>
host_vector<typename Container::value_type> make_pinned_vector_async(Container const& c,
                                                                      rmm::cuda_stream_view stream)
  requires(std::is_convertible_v<Container, device_span<typename Container::value_type const>>)
{
  return make_pinned_vector_async(device_span<typename Container::value_type const>{c}, stream);
}
```

2. Now look at the code under `cudf/cpp/src/io/parquet`. There are several places where we manually create pinned vectors using `make_pinned_vector_async` and either std::copy, std::move, or `cuda_memcpy_async` to copy the data to the pinned vector. Replace these with the new pinned vector factories. Note: To do this step, search for `make_pinned_vector` string in `cudf/cpp/src/io/parquet` and you will find all potentially replacable occurrences of `make_pinned_vector` and `make_pinned_vector_async` that need to be replaced with the new factory functions.

For example in `reader_impl_chunking_utils.cu`:

```c++
auto h_aggregated_info =
    cudf::detail::make_pinned_vector_async<cumulative_page_info>(aggregated_info.size(), stream);
cudf::detail::cuda_memcpy(
  cudf::host_span<cumulative_page_info>{h_aggregated_info.data(), aggregated_info.size()},
  cudf::device_span<cumulative_page_info const>{aggregated_info.data(), aggregated_info.size()},
  stream);
```

should be replaced with:
```c++
auto h_aggregated_info = cudf::detail::make_pinned_vector(aggregated_info, stream);
```

Similarly, in `reader_impl_preprocess.cu`:

```c++
auto pinned_nullmask_bufs =
    cudf::detail::make_pinned_vector_async<cudf::device_span<cudf::bitmask_type>>(
      nullmask_bufs.size(), _stream);
std::move(nullmask_bufs.begin(), nullmask_bufs.end(), pinned_nullmask_bufs.begin());
cudf::detail::batched_memset<cudf::bitmask_type>(
  pinned_nullmask_bufs, std::numeric_limits<cudf::bitmask_type>::max(), _stream);
```

should be replaced with:

```c++
auto pinned_nullmask_bufs = cudf::detail::make_pinned_vector_async(nullmask_bufs, _stream);
```

Similarly in `reader_impl.cpp`

```c++
  // Copy over initial string offsets from device
  auto h_initial_str_offsets =
    cudf::detail::make_pinned_vector_async<size_t>(initial_str_offsets.size(), _stream);
  cudf::detail::cuda_memcpy_async(
    cudf::host_span<size_t>{h_initial_str_offsets},
    cudf::device_span<size_t const>{initial_str_offsets.data(), initial_str_offsets.size()},
    _stream);
```

should be replaced with:

```c++
  // Copy over initial string offsets from device
  auto h_initial_str_offsets =
    cudf::detail::make_pinned_vector_async<size_t>(initial_str_offsets, _stream);
```

Make sure you can't find any other occurances of pinned vector construction from a host, std or device vector anymore.

3. Now run `set-native` in terminal from anywhere. Now navigate to `/home/coder/cudf/cpp` and run this script `build-cudf-cpp` in terminal to build libcudf. Do not use ninja or anything, just call `build-cudf-cpp` as it will take care of everything. Make sure to run `set-native` alias before running `build-cudf-cpp`.

4. Make sure there are no errors in the build. If any, please fix them and re-run.

5. Once the build is successful, navigate to `cudf/cpp/build/latest/gtests` and run `./PARQUET_TEST` and `./HYBRID_SCAN_TEST`. Make sure there are no errors in the tests. If any, please fix them and re-run.

6. Once the tests are successful, you can submit the PR.